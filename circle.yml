machine:
  timezone:
    America/New_York
  services:
    - docker

checkout:
  post:
    - git submodule sync
    - git submodule update --init 

dependencies:
  pre:
    - sudo pip install awscli
    - docker info
    - docker build -t clamorisse/hugo:0.14 ./docker-hugo-blog
  override:
    - docker run -d -p 1313:1313 --name hugotest -v $(pwd)/content-hugo-blog/:/usr/src/blog clamorisse/hugo:0.14 hugo server --baseUrl=http://blog.cotero.org/ --appendPort=false --watch --bind=0.0.0.0; sleep 10

test:
  post:
    - docker ps -a
    - curl --retry 5 --retry-delay 5 -v http://localhost:1313
    - docker logs hugotest
    - if [  "$(ls -A content-hugo-blog/public)" ]; then echo "generated public dir"; else exit 5; fi
    - cat $(pwd)/content-hugo-blog/public/index.html
    
deployment:
  prod:
    branch: master
    commands:
      - aws s3 sync content-hugo-blog/public/ s3://blog.cotero.org/
  staging:
    branch: stage-tf
    commands:
      -aws s3 sync content-hugo-blog/public/ s3://blog-stage.cotero.org/
