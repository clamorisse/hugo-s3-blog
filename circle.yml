machine:
  timezone:
    America/New_York
  services:
    - docker

dependencies:
  pre:
    - sudo pip install awscli
    - docker info
    - docker build -t clamorisse/hugo:0.14 ./docker-hugo-blog
  override:
    - docker run --rm -it  -p 1313:1313 -v $(pwd)/content-hugo-blog/:/usr/src/blog clamorisse/hugo:0.14 hugo

test:
  post:
    - docker run -d -it  -p 1313:1313 -v $(pwd)/content-hugo-blog/:/usr/src/blog clamorisse/hugo:0.14 hugo server --watch --bind 0.0.0.0; sleep 5
    - curl --retry 2 --retry-delay 5 -v http://localhost:1313
    - if [  "$(ls -A content-hugo-blog/public)" ]; then echo "generated public dir"; else exit 5; fi
    
deployment:
  prod:
    branch: master
    commands:
      - aws s3 sync content-hugo-blog/public/ s3://clamorisse-blog/
